<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éä„Ç¶„Ç∑„Ç´.ai - Player</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* FLAC Player specific styles */
        .player-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .player-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .player-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .player-header p {
            color: #888;
            font-size: 0.9rem;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #888;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #00d4aa;
            background: rgba(0, 212, 170, 0.1);
        }

        /* TXID Input */
        .txid-section {
            margin-bottom: 30px;
        }

        .txid-input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .txid-input {
            flex: 1;
            min-width: 200px;
            padding: 14px 16px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-family: monospace;
        }

        .txid-input:focus {
            outline: none;
            border-color: #00d4aa;
        }

        .load-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #00d4aa, #00a080);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
        }

        .load-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading state */
        .loading-section {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading-section.visible {
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #00d4aa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #888;
        }

        .loading-progress {
            margin-top: 15px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4aa, #00a080);
            transition: width 0.3s ease;
        }

        /* Player section */
        .player-section {
            display: none;
            flex: 1;
        }

        .player-section.visible {
            display: flex;
            flex-direction: column;
        }

        /* Album art / visualization */
        .album-art {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, #1a1a2e, #2d2d44);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* Track info */
        .track-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .track-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .track-meta {
            color: #888;
            font-size: 0.9rem;
        }

        /* Audio controls */
        .audio-controls {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 25px 20px;
            margin-top: auto;
        }

        /* Progress bar */
        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4aa, #00a080);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-bar-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .progress-bar:hover .progress-bar-handle {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
            margin-top: 8px;
        }

        /* Playback controls */
        .playback-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
        }

        .play-btn {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #00d4aa, #00a080);
            border-radius: 50%;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.4);
        }

        .play-btn svg {
            width: 28px;
            height: 28px;
        }

        /* Volume control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-icon {
            color: #888;
            font-size: 1.2rem;
        }

        /* Download button */
        .download-section {
            margin-top: 20px;
            text-align: center;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #333;
            border: 1px solid #444;
            border-radius: 10px;
            color: #fff;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .download-btn:hover {
            background: #444;
            border-color: #00d4aa;
        }

        /* Cover art image */
        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        /* Lyrics section */
        .lyrics-section {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .lyrics-section.visible {
            display: block;
        }

        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lyrics-header h3 {
            color: #00d4aa;
            font-size: 1rem;
            margin: 0;
        }

        .lyrics-toggle {
            background: none;
            border: 1px solid #444;
            color: #888;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .lyrics-toggle:hover {
            border-color: #00d4aa;
            color: #00d4aa;
        }

        .lyrics-content {
            color: #ccc;
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.8;
            max-height: 200px;
            overflow-y: auto;
        }

        .lyrics-content.expanded {
            max-height: none;
        }

        /* Error state */
        .error-message {
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #ff6464;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* Mobile responsive */
        @media (max-width: 480px) {
            .player-container {
                padding: 15px;
            }

            .player-header h1 {
                font-size: 1.5rem;
            }

            .txid-input-group {
                flex-direction: column;
            }

            .txid-input {
                min-width: 100%;
            }

            .load-btn {
                width: 100%;
            }

            .album-art {
                max-width: 250px;
                font-size: 60px;
            }

            .playback-controls {
                gap: 15px;
            }

            .play-btn {
                width: 56px;
                height: 56px;
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <nav class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/flac/upload" class="nav-link">Upload</a>
            <a href="/flac/player" class="nav-link active">Player</a>
        </nav>

        <div class="player-header">
            <h1>Player</h1>
            <p>Â•Ω„Åç„Å™Èü≥Ê•Ω„ÇíÂ•Ω„Åç„Å™„Å†„Åë</p>
        </div>

        <!-- TXID Input Section -->
        <div class="txid-section" id="txidSection">
            <div class="txid-input-group">
                <input type="text" class="txid-input" id="txidInput" 
                       placeholder="Enter Manifest TXID (64 characters)"
                       maxlength="64">
                <button class="load-btn" id="loadBtn">Load Audio</button>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="loading-section" id="loadingSection">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Fetching from blockchain...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Player Section -->
        <div class="player-section" id="playerSection">
            <div class="album-art" id="albumArt">üéµ</div>

            <div class="track-info">
                <div class="track-title" id="trackTitle">-</div>
                <div class="track-meta" id="trackMeta">FLAC ‚Ä¢ Blockchain Audio</div>
            </div>

            <div class="audio-controls">
                <!-- Progress bar -->
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-bar-fill" id="progressFill"></div>
                        <div class="progress-bar-handle" id="progressHandle"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>

                <!-- Playback controls -->
                <div class="playback-controls">
                    <button class="control-btn" id="rewindBtn" title="Rewind 10s">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.5 3C17.15 3 21.08 6.03 22.47 10.22L20.1 11C19.05 7.81 16.04 5.5 12.5 5.5C10.54 5.5 8.77 6.22 7.38 7.38L10 10H3V3L5.6 5.6C7.45 4 9.85 3 12.5 3M10 12V22H8V14H6V12H10M18 14V20C18 21.11 17.11 22 16 22H14C12.9 22 12 21.1 12 20V14C12 12.9 12.9 12 14 12H16C17.11 12 18 12.9 18 14M14 14V20H16V14H14Z"/>
                        </svg>
                    </button>

                    <button class="control-btn play-btn" id="playBtn" title="Play/Pause">
                        <svg viewBox="0 0 24 24" fill="currentColor" id="playIcon">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg viewBox="0 0 24 24" fill="currentColor" id="pauseIcon" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>

                    <button class="control-btn" id="forwardBtn" title="Forward 10s">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.5 3C6.85 3 2.92 6.03 1.53 10.22L3.9 11C4.95 7.81 7.96 5.5 11.5 5.5C13.46 5.5 15.23 6.22 16.62 7.38L14 10H21V3L18.4 5.6C16.55 4 14.15 3 11.5 3M10 12V22H8V14H6V12H10M18 14V20C18 21.11 17.11 22 16 22H14C12.9 22 12 21.1 12 20V14C12 12.9 12.9 12 14 12H16C17.11 12 18 12.9 18 14M14 14V20H16V14H14Z"/>
                        </svg>
                    </button>
                </div>

                <!-- Volume control -->
                <div class="volume-control">
                    <span class="volume-icon" id="volumeIcon">üîä</span>
                    <input type="range" class="volume-slider" id="volumeSlider" 
                           min="0" max="100" value="100">
                </div>
            </div>

            <!-- Lyrics section -->
            <div class="lyrics-section" id="lyricsSection">
                <div class="lyrics-header">
                    <h3>Lyrics</h3>
                    <button class="lyrics-toggle" id="lyricsToggle">Expand</button>
                </div>
                <div class="lyrics-content" id="lyricsContent"></div>
            </div>

            <!-- Download section -->
            <div class="download-section">
                <a class="download-btn" id="downloadBtn" href="#" download>
                    ‚¨áÔ∏è Download FLAC
                </a>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="auto"></audio>

    <script>
        const txidInput = document.getElementById('txidInput');
        const loadBtn = document.getElementById('loadBtn');
        const txidSection = document.getElementById('txidSection');
        const loadingSection = document.getElementById('loadingSection');
        const playerSection = document.getElementById('playerSection');
        const errorMessage = document.getElementById('errorMessage');
        const audioPlayer = document.getElementById('audioPlayer');

        let currentJobId = null;

        // Load audio from TXID
        loadBtn.addEventListener('click', loadAudio);
        txidInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadAudio();
        });

        async function loadAudio() {
            const txid = txidInput.value.trim();
            
            if (txid.length !== 64) {
                showError('Please enter a valid 64-character TXID');
                return;
            }

            // Show loading
            loadingSection.classList.add('visible');
            playerSection.classList.remove('visible');
            errorMessage.classList.remove('visible');
            loadBtn.disabled = true;

            try {
                const response = await fetch('/api/flac/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ txid })
                });

                const data = await response.json();

                if (data.success) {
                    currentJobId = data.job_id;
                    pollDownloadStatus();
                } else {
                    showError(data.error || 'Failed to start download');
                    loadBtn.disabled = false;
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                loadBtn.disabled = false;
            }
        }

        async function pollDownloadStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/flac/status/${currentJobId}`);
                const data = await response.json();

                document.getElementById('loadingText').textContent = data.message;
                document.getElementById('loadingProgressBar').style.width = data.progress + '%';

                if (data.status === 'complete') {
                    loadingSection.classList.remove('visible');
                    showPlayer(data);
                } else if (data.status === 'error') {
                    loadingSection.classList.remove('visible');
                    showError(data.message);
                    loadBtn.disabled = false;
                } else {
                    setTimeout(pollDownloadStatus, 1000);
                }
            } catch (error) {
                console.error('Status check failed:', error);
                setTimeout(pollDownloadStatus, 2000);
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
            loadingSection.classList.remove('visible');
        }

        function showPlayer(data) {
            playerSection.classList.add('visible');
            
            // Set track title (prefer track_title over filename)
            const displayTitle = data.track_title || data.filename || 'Unknown Track';
            document.getElementById('trackTitle').textContent = displayTitle;
            
            // Set cover art if available
            const albumArt = document.getElementById('albumArt');
            if (data.cover_txid) {
                // Load cover image from BSV (future implementation)
                // For now, show placeholder
                albumArt.innerHTML = 'üéµ';
            } else {
                albumArt.innerHTML = 'üéµ';
            }
            
            // Set lyrics if available
            const lyricsSection = document.getElementById('lyricsSection');
            const lyricsContent = document.getElementById('lyricsContent');
            if (data.lyrics) {
                lyricsContent.textContent = data.lyrics;
                lyricsSection.classList.add('visible');
            } else {
                lyricsSection.classList.remove('visible');
            }
            
            // Set audio source
            audioPlayer.src = data.download_link;
            
            // Set download link
            document.getElementById('downloadBtn').href = data.download_link;
            document.getElementById('downloadBtn').download = data.filename || 'audio.flac';
        }

        // Lyrics toggle functionality
        document.getElementById('lyricsToggle').addEventListener('click', function() {
            const lyricsContent = document.getElementById('lyricsContent');
            const isExpanded = lyricsContent.classList.toggle('expanded');
            this.textContent = isExpanded ? 'Collapse' : 'Expand';
        });

        // Audio player controls
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const progressHandle = document.getElementById('progressHandle');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIcon = document.getElementById('volumeIcon');

        playBtn.addEventListener('click', togglePlay);

        function togglePlay() {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                audioPlayer.pause();
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        audioPlayer.addEventListener('timeupdate', () => {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressFill.style.width = progress + '%';
            progressHandle.style.left = progress + '%';
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        });

        progressBar.addEventListener('click', (e) => {
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        });

        // Rewind/Forward buttons
        document.getElementById('rewindBtn').addEventListener('click', () => {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
        });

        document.getElementById('forwardBtn').addEventListener('click', () => {
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
        });

        // Volume control
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            audioPlayer.volume = volume;
            updateVolumeIcon(volume);
        });

        function updateVolumeIcon(volume) {
            if (volume === 0) {
                volumeIcon.textContent = 'üîá';
            } else if (volume < 0.5) {
                volumeIcon.textContent = 'üîâ';
            } else {
                volumeIcon.textContent = 'üîä';
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Check for TXID in URL
        const urlParams = new URLSearchParams(window.location.search);
        const txidParam = urlParams.get('txid');
        if (txidParam && txidParam.length === 64) {
            txidInput.value = txidParam;
            loadAudio();
        }
    </script>
</body>
</html>
